import { client } from "./libsql";

export interface Site {
  id: string;
  name: string;
  domain: string | null;
  amazonAssociateTag: string | null;
}

export interface Article {
  id: string;
  siteId: string;
  title: string;
  slug: string;
  content: string;
  status: string;
  articleType: string;
  createdAt?: string;
}

export interface Product {
  asin: string;
  title: string;
  localImageUrl: string;
  affiliateUrl: string;
}

export interface ArticleImage {
  articleId: string;
  imageType: string;
  r2Url: string;
  altText: string;
}

export async function getSite(siteId: string): Promise<Site | null> {
  const result = await client.execute({
    sql: "SELECT * FROM sites WHERE id = ?",
    args: [siteId],
  });
  return (result.rows[0] as unknown as Site) || null;
}

export async function getArticles(siteId: string): Promise<Article[]> {
  const result = await client.execute({
    sql: "SELECT * FROM articles WHERE siteId = ? AND status = 'published' ORDER BY id DESC",
    args: [siteId],
  });
  return result.rows as unknown as Article[];
}

export async function getArticleBySlug(
  siteId: string,
  slug: string
): Promise<Article | null> {
  const result = await client.execute({
    sql: "SELECT * FROM articles WHERE siteId = ? AND slug = ? AND status = 'published'",
    args: [siteId, slug],
  });
  return (result.rows[0] as unknown as Article) || null;
}

export async function getArticleImages(
  articleId: string
): Promise<ArticleImage[]> {
  const result = await client.execute({
    sql: "SELECT * FROM article_images WHERE articleId = ?",
    args: [articleId],
  });
  return result.rows as unknown as ArticleImage[];
}

export async function getArticleProducts(
  articleId: string
): Promise<Product[]> {
  // Assuming a junction table or a direct link if products are tied to articles
  // For now, let's look for products that might be referenced in the article or a related table
  // The README implies products are synchronized for articles.
  // If there's no junction table mentioned, I'll assume they might be linked by articleId if the schema allows,
  // or I might need to query them differently.
  // Let's assume there is an article_products table based on standard patterns.
  try {
    const result = await client.execute({
      sql: "SELECT p.* FROM products p JOIN article_products ap ON p.asin = ap.asin WHERE ap.articleId = ?",
      args: [articleId],
    });
    return result.rows as unknown as Product[];
  } catch (e) {
    console.error("Error fetching products:", e);
    return [];
  }
}
